# MQTT

## 1、介绍

`MQTT`**是机器对机器(**`M2M`**)/物联网(**`IoT`**)连接协议。它被设计为一个极其轻量级的**`发布/订阅`**消息传输协议。对于需要较小代码占用空间和/或网络带宽非常宝贵的远程连接非常有用，是专为受限设备和低带宽、高延迟或不可靠的网络而设计。**

**类比与微博的订阅式，多个客户端订阅同一个服务端，当有客户端向服务端发送数据时，若有其他客户端关注了相应的主题，则由服务端向客户端进行发送数据。**

**每个客户段既是发送端，也是接收端。**

## 2、特点

|   特点   | 介绍                                                   |
| :------: | ------------------------------------------------------ |
| 消息模式 | 一个服务端中含有多个设备，一对多。                     |
| 可靠连接 | 基于TCP/IP协议栈                                       |
| 服务等级 | 根据优先级，有三种不同的Qos。                          |
|  轻量级  |                                                        |
| 遗嘱机制 | 若服务端断开连接（失去心跳），便会对所有客户端进通知。 |
| 主题机制 | 服务端中含有多个主题，不同客户端对不同主题选择不一。   |



### 2.1、服务质量(Qos)

- `Qos0:`最多发送一次。**<= 1. 同时不会检测数据是否正常接收到。**
- `Qos1:`最少发送一次。**>= 1.**
- `Qos2:`只发送一次。**= 1.**

### 2.2、帧格式

#### 2.2.1、固定报头(fixed frame)

![image-20230710164054115](D:\MarkdowPad2_md\随手记\images\image-20230710164054115.png)

第1个字节：

- 高四位：报文类型；
- 低四位：与报文类型相关的标志位；

第2个字节及以后的字节（至多4个字节）是剩余数据的长度。（remianing length）

**高四位报文类型：**

![image-20230710164432770](D:\MarkdowPad2_md\随手记\images\image-20230710164432770.png)
![image-20230710164442246](D:\MarkdowPad2_md\随手记\images\image-20230710164442246.png)

**低四位报文类型标志位：**

![image-20230710164730938](D:\MarkdowPad2_md\随手记\images\image-20230710164730938.png)

其中：

- `DUP:`是`PUBLISH`报文重复的传送的标注位；
- `Qos(2 bits):` `PUBLISH`报文的服务质量等级；
- `RETAIN:` `PUBLISH`报文的保留位；

`DUP:`

- 0：客户端 、服务端第一次尝试发送此`publish`报文数据包；
- 1：可能是对之前尝试发送的数据包进行重新发送。当客户端或服务端进行重新发送`publish`报文数据包时，`DUP`必须为**1**。



`剩余长度(remaining length):`包长度，最多扩展4个字节。

![image-20230710174830272](D:\MarkdowPad2_md\随手记\images\image-20230710174830272.png)



#### 2.2.2、可变报头（variable header）

在固定报头和有效荷载之间，有些报文不需要，有些报文需要加上。

![image-20230711105435064](D:\MarkdowPad2_md\随手记\images\image-20230711105435064.png)

**可变报文头主要包含协议名、协议版本、连接标志（Connect Flags）、心跳间隔时间（Keep Alive timer）、连接返回码（Connect Return Code）、主题名（Topic Name）等。**

![image-20230711105940732](D:\MarkdowPad2_md\随手记\images\image-20230711105940732.png)



#### 2.2.3、有效荷载（padload）

**某些 MQTT 控制报文在报文的最后部分包含一个有效载荷。 对于 PUBLISH 来说有效载荷就是应用消息。**

![image-20230711110522537](D:\MarkdowPad2_md\随手记\images\image-20230711110522537.png)

### 2.3、流程图

![image-20230710161424059](D:\MarkdowPad2_md\随手记\images\image-20230710161424059.png)